name: Security Scans

on:
  schedule:
    # 每周一凌晨3点执行
    - cron: '0 3 * * 1'
  push:
    branches: [ main ]
    paths:
      - '**.sh'
      - 'deploy-production.yaml'
      - 'config-production.yaml'

jobs:
  security-scan:
    name: Security Scan
    runs-on: ubuntu-latest
    if: github.event_name == 'schedule' || github.event_name == 'push'
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up kubectl
        uses: azure/setup-kubectl@v3
        with:
          version: 'v1.28.0'

      - name: Set up kubeconfig
        run: |
          echo "${{ secrets.KUBE_CONFIG_TEST }}" | base64 -d > kubeconfig
          export KUBECONFIG=kubeconfig

      - name: Run security scan
        run: |
          ./security-scan.sh full

      - name: Upload security scan results
        uses: actions/upload-artifact@v3
        with:
          name: security-scan-results-${{ github.run_number }}
          path: /tmp/helm-proxy-security-scan/

      - name: Upload SARIF to GitHub
        if: always()
        uses: github/codeql-action/upload-sarif@v2
        with:
          sarif_file: /tmp/helm-proxy-security-scan/security_report_*.html

      - name: Notify security scan status
        if: always()
        run: |
          if [ "${{ job.status }}" == "success" ]; then
            echo "✅ Security scan completed" | tee -a $GITHUB_STEP_SUMMARY
          else
            echo "❌ Security scan failed" | tee -a $GITHUB_STEP_SUMMARY
          fi
        env:
          SLACK_WEBHOOK: ${{ secrets.SLACK_WEBHOOK }}

  dependency-scan:
    name: Dependency Vulnerability Scan
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Run Trivy vulnerability scanner in fs mode
        uses: aquasecurity/trivy-action@master
        with:
          scan-type: 'fs'
          scan-ref: '.'
          format: 'sarif'
          output: 'trivy-results.sarif'

      - name: Upload Trivy scan results to GitHub Security tab
        uses: github/codeql-action/upload-sarif@v2
        with:
          sarif_file: 'trivy-results.sarif'

      - name: Setup Go
        uses: actions/setup-go@v4
        with:
          go-version: '1.21'

      - name: Run Gosec Security Scanner
        uses: securecodewarrior/github-action-gosec@master
        with:
          args: './...'
